<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Lankan Dates ‚ù§Ô∏è</title>
    <style>
        /* --- WHATSAPP MOBILE STYLE --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #e5ddd5; 
            margin: 0; 
            padding: 0;
            display: flex; 
            flex-direction: column;
            height: 100dvh; /* Dynamic Height for Mobile */
            overflow: hidden; 
        }

        /* Sidebar (Hidden by default on mobile) */
        #sidebar { 
            position: absolute;
            left: -100%;
            top: 0;
            bottom: 0;
            width: 80%; 
            max-width: 300px;
            background: white; 
            z-index: 1000;
            transition: 0.3s;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }
        #sidebar.show { left: 0; }
        #overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:900; }

        /* Header */
        #header { 
            padding: 0 15px; 
            background: #008069; /* WhatsApp Green */
            color: white; 
            display: flex; 
            align-items: center; 
            gap: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            z-index: 10;
            height: 60px;
            flex-shrink: 0;
        }

        .menu-btn { font-size: 24px; cursor: pointer; }
        .profile-pic { width: 40px; height: 40px; border-radius: 50%; background: #ccc; object-fit: cover; border: 1px solid white; }
        .header-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .header-name { font-weight: bold; font-size: 16px; line-height: 1.2; }
        .header-status { font-size: 12px; opacity: 0.8; }

        /* Messages Area */
        #messages { 
            flex: 1; 
            padding: 15px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            background-color: #e5ddd5;
            background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
            background-repeat: repeat;
            opacity: 1;
            overscroll-behavior: contain;
        }
        
        /* Message Bubbles */
        .msg { 
            max-width: 85%; 
            padding: 8px 12px; 
            border-radius: 8px; 
            font-size: 15px; 
            line-height: 1.4; 
            position: relative; 
            word-wrap: break-word; 
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        
        .msg.user { 
            align-self: flex-end; 
            background: #dcf8c6; 
            color: black; 
            border-top-right-radius: 0;
        }
        
        .msg.ai { 
            align-self: flex-start; 
            background: #ffffff; 
            color: black; 
            border-top-left-radius: 0;
        }

        .msg-time {
            font-size: 10px;
            color: #999;
            text-align: right;
            margin-top: 4px;
            float: right;
            margin-left: 10px;
        }
        
        /* Input Area (Keyboard Safe) */
        #input-area { 
            padding: 8px 10px; 
            background: #f0f0f0; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            min-height: 60px;
            flex-shrink: 0; 
        }
        
        input { 
            flex: 1; 
            padding: 12px 15px; 
            border: none; 
            border-radius: 25px; 
            outline: none; 
            font-size: 16px; 
            background: white;
        }
        
        button#send-btn { 
            width: 45px; 
            height: 45px; 
            background: #008069; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Character List Styles */
        .char-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; cursor: pointer; }
        .char-item:hover { background: #f5f5f5; }
        
        /* Modals */
        .photo-container { position: relative; max-width: 260px; border-radius: 10px; overflow: hidden; margin-top: 5px; background: #000; border: 2px solid #25D366; }
        .photo-blur { width: 100%; height: 320px; object-fit: cover; filter: blur(20px); opacity: 0.8; }
        .photo-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .unlocked .photo-blur { filter: blur(0); opacity: 1; }
        .unlocked .photo-overlay { display: none; }
    </style>
</head>
<body>

<div id="overlay" onclick="toggleSidebar()"></div>
<div id="sidebar">
    <div style="padding:20px; background:#008069; color:white; font-size:18px; font-weight:bold;">
        Lankan Dates ‚ù§Ô∏è
    </div>
    <div id="char-list" style="overflow-y:auto; flex:1;"></div>
    <div style="padding:15px; text-align:center; border-top:1px solid #ddd;">
        <button onclick="enterCode()" style="background:none; border:none; color:#008069; font-weight:bold; cursor:pointer;">üîë I have a Premium Code</button>
    </div>
</div>

<div id="chat-area">
    <div id="header">
        <div class="menu-btn" onclick="toggleSidebar()">‚¨ÖÔ∏è</div>
        <img id="header-img" class="profile-pic" src="">
        <div class="header-info">
            <span id="header-name" class="header-name">Select a girl</span>
            <span class="header-status">online</span>
        </div>
    </div>
    
    <div id="messages">
        <div style="text-align:center; margin-top:50%; color:#888;">
            <p>Tap the ‚¨ÖÔ∏è button to pick a girl!</p>
        </div>
    </div>

    <div id="input-area">
        <input type="text" id="user-input" placeholder="Message" disabled>
        <button id="send-btn" onclick="sendMessage()">‚û§</button>
    </div>
</div>

<script>
    // ================= CONFIGURATION =================
    const WORKER_URL = "https://chatgirl.ranbindua.workers.dev"; 
    const SECRET_UNLOCK_CODE = "LOVE2026"; 
    // =================================================

    let isPremium = false;
    let currentCharacter = null;
    let chatHistory = [];

    // --- SINGLISH PROMPT ---
    const BASE_INSTRUCTION = `
    You are a Sri Lankan girl chatting on WhatsApp.
    RULES:
    1. Speak ONLY in "Singlish" (Sinhala words in English letters).
    2. NEVER use formal English (e.g., don't say "How are you?", say "Kohomada?").
    3. Use fillers: "Ane", "Mata", "Oya", "Baba", "Na", "Ow".
    4. Keep replies short, casual and fun.
    `;

    // --- CHARACTERS (Updated to .png) ---
    const characters = [
        { id: 1, name: "Kavindya", img: "1000101736.png", photos: ["1000101736.png"], systemPrompt: `${BASE_INSTRUCTION} You are Kavindya. Innocent but ambitious. Call him 'baba'. Reply '[SEND_PHOTO]' if asked for pics.` },
        { id: 2, name: "Nipuni", img: "2.png", photos: ["2.png"], systemPrompt: `${BASE_INSTRUCTION} You are Nipuni, a village girl. Shy. Use "Ane aiye". Reply '[SEND_PHOTO]' if asked for pics.` },
        { id: 3, name: "Sajani", img: "3.png", photos: ["3.png"], systemPrompt: `${BASE_INSTRUCTION} You are Sajani. Strict and direct. Reply '[SEND_PHOTO]' if asked for pics.` },
        { id: 4, name: "Pawani", img: "4.png", photos: ["4.png"], systemPrompt: `${BASE_INSTRUCTION} You are Pawani. Naughty and flirty. Reply '[SEND_PHOTO]' if asked for pics.` },
        { id: 5, name: "Saththya", img: "5.png", photos: ["5.png"], systemPrompt: `${BASE_INSTRUCTION} You are Saththya. Lonely single mom. Reply '[SEND_PHOTO]' if asked for pics.` }
    ];

    // Load Sidebar
    const charList = document.getElementById('char-list');
    characters.forEach(char => {
        const div = document.createElement('div');
        div.className = 'char-item';
        // Avatar fix with fallback
        div.innerHTML = `
            <img src="${char.img}" class="profile-pic" onerror="this.src='https://ui-avatars.com/api/?name=${char.name}&background=random'">
            <div><b>${char.name}</b></div>
        `;
        div.onclick = () => loadCharacter(char);
        charList.appendChild(div);
    });

    function loadCharacter(char) {
        currentCharacter = char;
        chatHistory = [];
        document.getElementById('header-name').innerText = char.name;
        
        // Set Header Image with fallback
        const headerImg = document.getElementById('header-img');
        headerImg.src = char.img;
        headerImg.onerror = function() { this.src = `https://ui-avatars.com/api/?name=${char.name}&background=random`; };

        document.getElementById('messages').innerHTML = '';
        document.getElementById('user-input').disabled = false;
        
        toggleSidebar();

        // System Prompt
        chatHistory.push({ role: "system", content: char.systemPrompt });
        
        // Welcome Message
        setTimeout(() => {
            const welcome = char.id === 1 ? "Hi baba... kohomada?" : "Hi oya... kohomada?";
            addMessage(welcome, 'ai');
        }, 300);
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('show');
        const overlay = document.getElementById('overlay');
        overlay.style.display = overlay.style.display === 'block' ? 'none' : 'block';
    }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if (!text) return;

        // User Message
        addMessage(text, 'user');
        input.value = '';
        input.focus(); // Keep keyboard up for fast chatting

        chatHistory.push({ role: "user", content: text });

        // Typing Indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'msg ai';
        loadingDiv.innerHTML = '<span style="font-style:italic; color:#777;">typing...</span>';
        loadingDiv.id = 'loading';
        document.getElementById('messages').appendChild(loadingDiv);
        scrollToBottom();

        try {
            const response = await fetch(WORKER_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    // === LATEST MODEL from your list ===
                    "model": "google/gemini-2.5-flash", 
                    "messages": chatHistory
                })
            });

            const data = await response.json();
            document.getElementById('loading').remove();

            if(data.error) {
                // Show clean error
                addMessage("‚ö†Ô∏è Error: " + (data.error.message || "Unknown error"), 'ai');
                console.error(data.error);
                return;
            }
            
            let reply = data.choices[0].message.content;

            if (reply.includes("[SEND_PHOTO]")) {
                sendPhoto();
            } else {
                addMessage(reply, 'ai');
                chatHistory.push({ role: "assistant", content: reply });
            }

        } catch (e) {
            if(document.getElementById('loading')) document.getElementById('loading').remove();
            addMessage("‚ö†Ô∏è Network Error. Check internet.", 'ai');
        }
    }

    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `msg ${sender}`;
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        div.innerHTML = `${text} <span class="msg-time">${time}</span>`;
        const msgs = document.getElementById('messages');
        msgs.appendChild(div);
        scrollToBottom();
    }

    function sendPhoto() {
        const randomPhoto = currentCharacter.photos[0]; // Use first photo for now
        const div = document.createElement('div');
        div.className = `msg ai`;
        div.style.background = "transparent";
        div.style.padding = "0";
        div.style.boxShadow = "none";
        
        div.innerHTML = `
            <div class="${isPremium ? 'photo-container unlocked' : 'photo-container'}">
                <img src="${randomPhoto}" class="photo-blur">
                <div class="photo-overlay">
                    <button onclick="enterCode()" style="padding:10px 20px; border-radius:20px; border:none; background:#008069; color:white; font-weight:bold;">Tap to Unlock üîí</button>
                </div>
            </div>`;
        document.getElementById('messages').appendChild(div);
        scrollToBottom();
    }

    function scrollToBottom() {
        const msgs = document.getElementById('messages');
        msgs.scrollTop = msgs.scrollHeight;
    }

    function enterCode() {
        const code = prompt("Enter Secret Code to Unlock Photos:");
        if(code === SECRET_UNLOCK_CODE) {
            isPremium = true;
            alert("‚úÖ Access Granted! Photos Unlocked.");
            document.querySelectorAll('.photo-container').forEach(el => el.classList.add('unlocked'));
        } else {
            alert("‚ùå Wrong Code!");
        }
    }
    
    // Enter key support
    document.getElementById("user-input").addEventListener("keypress", function(event) {
        if (event.key === "Enter") sendMessage();
    });
</script>

</body>
</html>
